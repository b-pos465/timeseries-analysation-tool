"use strict";angular.module("TimeseriesAnalysationTool",[]),angular.module("TimeseriesAnalysationTool").directive("threeDimChart",function(e,t,n,i,s){return{templateUrl:"app/chart/ThreeDimChart.html",restrict:"E",scope:{externData:"=data",externOptions:"=options"},link:function(i){function r(e){for(var t=1;i.possibleResolutions[t].value<=e.stepLength;)t++;return t--,i.possibleResolutions[t]}function a(){l.scene.yaxis.title=l.scene.xaxis.title=""}i.formatNumber=function(e){return s("number")(e,2)},i.range=[0,1],i.currentMin=i.range[0],i.currentMax=i.range[1],i.possibleColorscales=["Greys","YIGnBu","Greens","YIOrRd","Bluered","RdBu","Reds","Blues","Picnic","Rainbow","Portland","Jet","Hot","Blackbody","Earth","Electric","Viridis"],i.possibleResolutions=e.possibleResolutions,i.possibleAggregations=t.possibleAggregations;var l={title:null,autosize:!1,width:$(document).width()/2,height:$(document).width()/2,margin:{l:65,r:50,b:65,t:90},scene:{zaxis:{title:"Wert"},yaxis:{},xaxis:{}}};i.$watch("externOptions",function(e){if(e){if(i.possibleColorscales.indexOf(e.initialcolorscale)===-1)throw"Die Angabe für options.initialcolorscale ist nicht gültig!";i.color=i.initialcolorscale=e.initialcolorscale}else;i.change(e)}),i.$watch("externData",function(e){if(e){if(!angular.isArray(e.values))throw"data.values enthält kein Array!";for(var t=0;t<e.values.length;t++)if(!angular.isNumber(e.values[t]))throw"data.values muss ein 1-D Array aus numerischen Werten darstellen!";i.timeseries=angular.copy(e),i.range[0]=Math.min.apply(Math,i.timeseries.values),i.range[1]=Math.max.apply(Math,i.timeseries.values),i.currentMin=i.range[0],i.currentMax=i.range[1],i.options={yaxis:i.possibleResolutions[0].text},i.change(i.options)}},!0),i.change=function(e){var t=void 0,s=void 0,o=void 0;if(e){if(i.timeseries=angular.copy(i.externData),a(),e.yaxis)for(var u=0;u<i.possibleResolutions.length;u++)i.possibleResolutions[u].text===e.yaxis&&(t=i.possibleResolutions[u]);if(e.xaxis&&e.agg){for(u=0;u<i.possibleAggregations.length;u++)i.possibleAggregations[u].text===e.agg&&(s=i.possibleAggregations[u]);for(u=0;u<i.possibleResolutions.length;u++)i.possibleResolutions[u].text===e.xaxis&&(o=i.possibleResolutions[u])}if(t&&o&&s)n.divide(i.timeseries,t.calc),n.divide(i.timeseries,o.calc),n.aggregate(i.timeseries,s.calc),l.scene.xaxis.title=o.text+" "+i.options.agg,l.scene.yaxis.title=t.text;else if(t){n.divide(i.timeseries,t.calc,t);var c=r(i.timeseries);l.scene.yaxis.title=t.text,l.scene.xaxis.title="1 ≡ "+i.timeseries.stepLength/c.value+" "+c.text,"Original"===t.text&&(l.scene.yaxis.title=t.text+" ≡ "+i.timeseries.stepLength/c.value+" "+c.text)}i.refresh()}},i.$watch("options",function(e){i.change(e)},!0),i.resetSelection=function(){i.options.yaxis="Original",i.options.xaxis=void 0,i.options.agg=void 0},i.calculateRange=function(e){if(angular.isArray(e[0])){for(var t=[],n=[],s=0;s<e.length;s++)t.push(Math.min.apply(Math,e[s])),n.push(Math.max.apply(Math,e[s]));i.range[0]=Math.min.apply(Math,t),i.range[1]=Math.max.apply(Math,n)}else i.range[0]=Math.min.apply(Math,e),i.range[1]=Math.max.apply(Math,e);i.currentMin=i.range[0],i.currentMax=i.range[1]},i.refresh=function(){i.timeseries&&(i.calculateRange(i.timeseries.values),Plotly.newPlot("plotly",[{z:n.getRenderableValues(i.timeseries),type:"surface"}],l),i.color&&i.setColorscale(i.color))},i.getYAxisResolutionIndex=function(){if(!i.options||!i.options.yaxis)return-1;for(var e=0;e<i.possibleResolutions.length;e++)if(i.possibleResolutions[e].text===i.options.yaxis)return e},i.setMin=function(e){try{Plotly.restyle("plotly",{cmin:e})}catch(e){console.log("Plotly wurde noch nicht initialisiert.")}},i.setMax=function(e){try{Plotly.restyle("plotly",{cmax:e})}catch(e){console.log("Plotly wurde noch nicht initialisiert.")}},i.setColorscale=function(e){i.color=e;try{Plotly.restyle("plotly",{colorscale:e})}catch(e){console.log("Plotly wurde noch nicht initialisiert.")}}}}}),angular.module("TimeseriesAnalysationTool").run(["$templateCache",function(e){e.put("app/chart/ThreeDimChart.html",'<div class="row">\n    <div id="plotly" class="col-md-6"></div>\n    <div class="col-md-2 col-md-offset-2">\n        <div class="form-group">\n            <label for="sel1">Y-Achsen Auflösung:</label>\n            <select class="form-control" id="sel1" ng-model="options.yaxis" ng-disabled="options.xaxis">\n                <option ng-repeat="res in possibleResolutions" ng-disabled="timeseries.stepLength > res.value && res.value"\n                        ng-value="res.text">{{res.text}}</option>\n            </select>\n        </div>\n        <div class="form-group">\n            <label for="sel2">X-Achsen Aggregation:</label>\n            <select class="form-control" id="sel2" ng-model="options.xaxis">\n                <option ng-repeat="res in possibleResolutions" ng-disabled="timeseries.stepLength > res.value || $index > getYAxisResolutionIndex()"\n                        ng-value="res.text">{{res.text}}</option>\n            </select>\n        </div>\n        <div class="form-group">\n            <label for="sel3">Aggregationstyp:</label>\n            <select class="form-control" id="sel3" ng-model="options.agg" ng-disabled="!options.xaxis">\n                <option ng-repeat="agg in possibleAggregations">{{agg.text}}</option>\n            </select>\n        </div>\n        <button class="btn btn-default" ng-click="resetSelection()">\n            Auswahl zurücksetzen\n        </button>\n        <hr ng-if="!externOptions || externOptions.colorscale || externOptions.colorrange">\n        <div class="form-group" ng-if="!externOptions || externOptions.colorscale">\n            <label for="color">Farbskala:</label>\n            <select class="form-control" id="color" ng-model="color" ng-change="setColorscale(color)">\n                <option ng-repeat="c in possibleColorscales">{{c}}</option>\n            </select>\n        </div>\n        <div ng-if="!externOptions || externOptions.colorrange">\n            <label for="slider1" >Minimum: <i style="font-weight: normal" title="{{formatNumber(range[0])}} - {{formatNumber(currentMax)}}">{{formatNumber(currentMin)}}</i>\n                <input id="slider1" type="range" min="{{range[0]}}" max="{{currentMax}}" step="{{(currentMax - range[0]) / 100}}"\n                       ng-model="currentMin"\n                       style="width:300px"\n                       ng-change="setMin(currentMin)">\n            </label>\n\n            <label for="slider2">Maximum: <i style="font-weight: normal" title="{{formatNumber(currentMin)}} - {{formatNumber(range[1])}}">{{formatNumber(currentMax)}}</i>\n                <input id="slider2" type="range" min="{{currentMin}}" max="{{range[1]}}" step="{{(range[1] - currentMin) / 100}}"\n                       ng-model="currentMax"\n                       style="width:300px"\n                       ng-change="setMax(currentMax)">\n            </label>\n        </div>\n    </div>\n</div>\n\n\n\n')}]),angular.module("TimeseriesAnalysationTool").service("AggregatingService",function(){this.sum=function(e){return e.reduce(function(e,t){return e+t})};var e=this.sum;this.avg=function(t){return e(t)/t.length},this.max=function(e){for(var t=e[0],n=0;n<e.length;n++)e[n]>t&&(t=e[n]);return t},this.min=function(e){for(var t=e[0],n=0;n<e.length;n++)e[n]<t&&(t=e[n]);return t};var t=this;return this.possibleAggregations=[{text:"Summe",calc:t.sum},{text:"Durchschnitt",calc:t.avg},{text:"Maximum",calc:t.max},{text:"Minimum",calc:t.min}],this}),angular.module("TimeseriesAnalysationTool").service("DividingService",function(){function e(e,t){for(var n=[],i=0;i<e.length;i+=t)i+t<=e.length?n.push(e.slice(i,i+t)):n.push(e.slice(i));return n}var t=1e3,n=60*t,i=60*n,s=24*i,r=7*s,a=365*s,l=this;return this.getSeconds=function(n,i){return angular.isArray(n)?e(n,t/i):[n]},this.getMinutes=function(t,i){return angular.isArray(t)?e(t,n/i):[t]},this.getHours=function(t,n){return angular.isArray(t)?e(t,i/n):[t]},this.getDays=function(t,n){return angular.isArray(t)?e(t,s/n):[t]},this.getWeeks=function(t,n){return angular.isArray(t)?e(t,r/n):[t]},this.getYears=function(t,n){return angular.isArray(t)?e(t,a/n):[t]},this.possibleResolutions=[{text:"Original",value:null,calc:function(e){return _.map(e,function(e){return[e]})}},{text:"Sekunde/n",value:t,calc:l.getSeconds},{text:"Minute/n",value:n,calc:l.getMinutes},{text:"Stunde/n",value:i,calc:l.getHours},{text:"Tag/e",value:s,calc:l.getDays},{text:"Woche/n",value:r,calc:l.getWeeks},{text:"Jahr/e",value:a,calc:l.getYears}],this}),angular.module("TimeseriesAnalysationTool").service("TimeseriesUtil",function(){return this.divide=function(e,t){var n=this.funcMostInnerArrays(e.values,e.values,t,0,!1,e);angular.isDefined(n)&&(e.values=n)},this.getRenderableValues=function(e){if(e.values&&e.values.length>1&&1===e.values[0].length){for(var t=angular.copy(e.values),n=0;n<e.values.length;n++)t[n].push(t[n][0]);return t}if(e.values&&1===e.values.length&&e.values[0].length>1)return t=angular.copy(e.values),t.push(t[0]),t;if(e.values&&1===e.values.length&&1===e.values[0].length){var i=e.values[0][0];return[[i,i],[i,i]]}return e.values},this.aggregate=function(e,t){var n=this.funcMostInnerArrays(e.values,e.values,t,0,!0,e);angular.isDefined(n)&&(e.values=n)},this.funcMostInnerArrays=function(e,t,n,i,s,r){if(angular.isArray(t)&&!angular.isArray(t[0])){var a=r.stepLength;if(s&&(r.stepLength*=t.length),e===t)return n(t,a,r.startDate);e[i]=n(t,a,r.startDate)}else for(var l=0;l<t.length;l++)this.funcMostInnerArrays(t,t[l],n,l,s,r)},this});